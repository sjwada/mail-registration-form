<script>
(()=>{var M=Object.defineProperty;var E=Object.getOwnPropertySymbols;var F=Object.prototype.hasOwnProperty,K=Object.prototype.propertyIsEnumerable;var S=(e,o,s)=>o in e?M(e,o,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[o]=s,b=(e,o)=>{for(var s in o||(o={}))F.call(o,s)&&S(e,s,o[s]);if(E)for(var s of E(o))K.call(o,s)&&S(e,s,o[s]);return e};var p=(e,o,s)=>new Promise((t,n)=>{var l=i=>{try{r(s.next(i))}catch(m){n(m)}},a=i=>{try{r(s.throw(i))}catch(m){n(m)}},r=i=>i.done?t(i.value):Promise.resolve(i.value).then(l,a);r((s=s.apply(e,o)).next())});var $=class{constructor(o={}){this.state=o,this.listeners=[]}getState(){return this.state}setState(o){this.state=b(b({},this.state),o),this.notify()}subscribe(o){return this.listeners.push(o),()=>{this.listeners=this.listeners.filter(s=>s!==o)}}notify(){this.listeners.forEach(o=>o(this.state))}},c=new $({mode:"new",guardianCount:0,studentCount:0,household:{},guardians:[],students:[]});function f(e,...o){return new Promise((s,t)=>{google.script.run.withSuccessHandler(s).withFailureHandler(t)[e](...o)})}function I(){let e=/^\d{3}-?\d{4}$/,o=/^0\d{1,4}-?\d{1,4}-?\d{3,4}$/,s=document.getElementById("postalCode").value;if(s&&!e.test(s))return{valid:!1,message:"\u4E16\u5E2F\u306E\u90F5\u4FBF\u756A\u53F7\u306E\u5F62\u5F0F\u304C\u6B63\u3057\u304F\u3042\u308A\u307E\u305B\u3093\u3002\uFF08\u4F8B: 123-4567\uFF09"};let t=document.querySelectorAll(".guardian-card");for(let l of t){let a=l.id,r=l.querySelector(`[name="mobile_phone_${a}"]`).value,i=l.querySelector(`[name="home_phone_${a}"]`).value,m=l.querySelector(`[name="postalCode_${a}"]`).value;if(!r&&!i)return{valid:!1,message:"\u4FDD\u8B77\u8005\u306E\u643A\u5E2F\u96FB\u8A71\u307E\u305F\u306F\u81EA\u5B85\u96FB\u8A71\u306E\u3069\u3061\u3089\u304B1\u3064\u306F\u5FC5\u9808\u3067\u3059\u3002"};if(r&&!o.test(r))return{valid:!1,message:"\u4FDD\u8B77\u8005\u306E\u643A\u5E2F\u96FB\u8A71\u756A\u53F7\u306E\u5F62\u5F0F\u304C\u6B63\u3057\u304F\u3042\u308A\u307E\u305B\u3093\u3002"};if(i&&!o.test(i))return{valid:!1,message:"\u4FDD\u8B77\u8005\u306E\u81EA\u5B85\u96FB\u8A71\u756A\u53F7\u306E\u5F62\u5F0F\u304C\u6B63\u3057\u304F\u3042\u308A\u307E\u305B\u3093\u3002"};if(m&&!e.test(m))return{valid:!1,message:"\u4FDD\u8B77\u8005\u306E\u90F5\u4FBF\u756A\u53F7\u306E\u5F62\u5F0F\u304C\u6B63\u3057\u304F\u3042\u308A\u307E\u305B\u3093\u3002"}}let n=document.querySelectorAll(".student-card");for(let l of n){let a=l.id,r=l.querySelector(`[name="s_mobile_phone_${a}"]`).value,i=l.querySelector(`[name="postalCode_s_${a}"]`).value;if(r&&!o.test(r))return{valid:!1,message:"\u751F\u5F92\u306E\u643A\u5E2F\u96FB\u8A71\u756A\u53F7\u306E\u5F62\u5F0F\u304C\u6B63\u3057\u304F\u3042\u308A\u307E\u305B\u3093\u3002"};if(i&&!e.test(i))return{valid:!1,message:"\u751F\u5F92\u306E\u90F5\u4FBF\u756A\u53F7\u306E\u5F62\u5F0F\u304C\u6B63\u3057\u304F\u3042\u308A\u307E\u305B\u3093\u3002"}}return{valid:!0}}function g(e=null){let s=c.getState().guardianCount+1;c.setState({guardianCount:s});let t="guardian_"+s,n=e&&(e.postalCode||e.prefecture||e.city||e.street),l=`
    <div class="guardian-card fade-in" id="${t}">
      <input type="hidden" name="guardianId_${t}" value="${e&&e.guardianId||""}">
      <div class="card-header">
        <h3>\u4FDD\u8B77\u8005${s}</h3>
        ${s>1?`<button type="button" class="btn btn-danger btn-sm remove-btn" data-remove-guardian="${t}">\u524A\u9664</button>`:""}
      </div>
      
      <div class="form-row">
        <div class="form-group col-md-4">
          <label>\u7D9A\u67C4 <span class="required">*</span></label>
          <select class="form-control" name="relationship_${t}" required>
            <option value="">\u9078\u629E</option>
            <option value="\u7236" ${e&&e.relationship==="\u7236"?"selected":""}>\u7236</option>
            <option value="\u6BCD" ${e&&e.relationship==="\u6BCD"?"selected":""}>\u6BCD</option>
            <option value="\u7956\u7236" ${e&&e.relationship==="\u7956\u7236"?"selected":""}>\u7956\u7236</option>
            <option value="\u7956\u6BCD" ${e&&e.relationship==="\u7956\u6BCD"?"selected":""}>\u7956\u6BCD</option>
            <option value="\u305D\u306E\u4ED6" ${e&&e.relationship==="\u305D\u306E\u4ED6"?"selected":""}>\u305D\u306E\u4ED6</option>
          </select>
        </div>
        <div class="form-group col-md-4">
          <label>\u9023\u7D61\u512A\u5148\u9806\u4F4D <span class="required">*</span></label>
          <select class="form-control priority-select" name="priority_${t}" required data-initial-priority="${e&&e.contactPriority||""}">
            <!-- Dynamically generated -->
          </select>
        </div>
        <div class="form-group col-md-4">
          <label>\u9023\u7D61\u624B\u6BB5</label>
          <select class="form-control" name="contact_method_${t}">
            <option value="\u643A\u5E2F\u96FB\u8A71" ${!e||e.contactMethod==="\u643A\u5E2F\u96FB\u8A71"?"selected":""}>\u643A\u5E2F\u96FB\u8A71</option>
            <option value="\u81EA\u5B85\u96FB\u8A71" ${e&&e.contactMethod==="\u81EA\u5B85\u96FB\u8A71"?"selected":""}>\u81EA\u5B85\u96FB\u8A71</option>
            <option value="\u30E1\u30FC\u30EB" ${e&&e.contactMethod==="\u30E1\u30FC\u30EB"?"selected":""}>\u30E1\u30FC\u30EB</option>
          </select>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group col-md-6">
          <label>\u59D3 <span class="required">*</span></label>
          <input type="text" class="form-control" name="last_name_${t}" value="${e?e.lastName:""}" required>
        </div>
        <div class="form-group col-md-6">
          <label>\u540D <span class="required">*</span></label>
          <input type="text" class="form-control" name="first_name_${t}" value="${e?e.firstName:""}" required>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group col-md-6">
          <label>\u30D5\u30EA\u30AC\u30CA\uFF08\u59D3\uFF09 <span class="required">*</span></label>
          <input type="text" class="form-control" name="last_name_kana_${t}" value="${e?e.lastNameKana:""}" pattern="[\u30A1-\u30F6\u30FC]+" required>
        </div>
        <div class="form-group col-md-6">
          <label>\u30D5\u30EA\u30AC\u30CA\uFF08\u540D\uFF09 <span class="required">*</span></label>
          <input type="text" class="form-control" name="first_name_kana_${t}" value="${e?e.firstNameKana:""}" pattern="[\u30A1-\u30F6\u30FC]+" required>
        </div>
      </div>
      
      <div class="form-group">
        <label>\u9023\u7D61\u7528\u30E1\u30FC\u30EB\u30A2\u30C9\u30EC\u30B9 <span class="required">*</span></label>
        <input type="email" class="form-control" name="email_${t}" value="${e?e.email:""}" required>
      </div>
      
      <div class="form-group">
        <label>\u30AA\u30F3\u30E9\u30A4\u30F3\u9762\u8AC7\u7528\u30E1\u30FC\u30EB\u30A2\u30C9\u30EC\u30B9\uFF08\u4EFB\u610F\uFF09</label>
        <input type="email" class="form-control" name="meeting_email_${t}" value="${e&&e.meetingEmail||""}">
        <small class="form-text">\u{1F4A1} PC/\u30BF\u30D6\u30EC\u30C3\u30C8\u3067\u78BA\u8A8D\u3057\u3084\u3059\u3044\u30E1\u30FC\u30EB\u30A2\u30C9\u30EC\u30B9\u63A8\u5968</small>
      </div>
      
      <div class="form-row">
        <div class="form-group col-md-6">
          <label>\u643A\u5E2F\u96FB\u8A71\u756A\u53F7</label>
          <input type="tel" class="form-control" name="mobile_phone_${t}" value="${e&&e.mobilePhone||""}" placeholder="090-1234-5678">
        </div>
        <div class="form-group col-md-6">
          <label>\u81EA\u5B85\u96FB\u8A71\u756A\u53F7</label>
          <input type="tel" class="form-control" name="home_phone_${t}" value="${e&&e.homePhone||""}" placeholder="03-1234-5678">
        </div>
      </div>
      <small class="form-text">\u{1F4DE} \u643A\u5E2F\u96FB\u8A71\u307E\u305F\u306F\u81EA\u5B85\u96FB\u8A71\u306E\u3069\u3061\u3089\u304B1\u3064\u306F\u5FC5\u305A\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044</small>

      <!-- Address Input -->
      <div class="form-group mt-3">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="separate_address_${t}" data-toggle-address="${t}" ${n?"checked":""}>
          <label class="form-check-label" for="separate_address_${t}">
            \u3054\u81EA\u5B85\u3068\u7570\u306A\u308B\u4F4F\u6240\u3092\u767B\u9332\u3059\u308B\uFF08\u5358\u8EAB\u8D74\u4EFB\u7B49\uFF09
          </label>
        </div>
      </div>
      
      <div id="address_fields_${t}" style="display: ${n?"block":"none"};" class="bg-light p-3 rounded">
        <div class="form-row">
          <div class="form-group col-md-4">
            <label>\u90F5\u4FBF\u756A\u53F7</label>
            <input type="text" id="postalCode_${t}" name="postalCode_${t}" class="form-control" placeholder="123-4567" maxlength="8" value="${e&&e.postalCode||""}">
            <button type="button" class="btn btn-sm btn-secondary mt-1" data-search-address="${t}">\u4F4F\u6240\u691C\u7D22</button>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group col-md-4">
            <label>\u90FD\u9053\u5E9C\u770C</label>
            <select id="prefecture_${t}" name="prefecture_${t}" class="form-control">
              <option value="">\u9078\u629E</option>
              ${H(e?e.prefecture:"")}
            </select>
          </div>
          <div class="form-group col-md-8">
            <label>\u5E02\u533A\u753A\u6751</label>
            <input type="text" id="city_${t}" name="city_${t}" class="form-control" value="${e&&e.city||""}">
          </div>
        </div>
        <div class="form-group">
          <label>\u753A\u540D\u30FB\u756A\u5730\u30FB\u53F7</label>
          <input type="text" id="street_${t}" name="street_${t}" class="form-control" value="${e&&e.street||""}">
        </div>
        <div class="form-group">
          <label>\u5EFA\u7269\u540D\u30FB\u90E8\u5C4B\u756A\u53F7</label>
          <input type="text" id="building_${t}" name="building_${t}" class="form-control" value="${e&&e.building||""}">
        </div>
      </div>
    </div>
  `;document.getElementById("guardiansList").insertAdjacentHTML("beforeend",l),C()}function B(e){confirm("\u3053\u306E\u4FDD\u8B77\u8005\u3092\u524A\u9664\u3057\u307E\u3059\u304B\uFF1F")&&(document.getElementById(e).remove(),C())}function C(){let e=document.querySelectorAll(".guardian-card"),o=e.length;e.forEach((s,t)=>{let n=s.querySelector(".priority-select"),l=n.value;l||(l=n.getAttribute("data-initial-priority")),l||(l=t+1);let a="";for(let r=1;r<=o;r++)a+=`<option value="${r}" ${l==r?"selected":""}>${r}</option>`;n.innerHTML=a,n.setAttribute("data-current-value",n.value)})}function k(e){let o=e.target,s=o.value,t=o.getAttribute("data-current-value");if(s===t)return;let n=document.querySelectorAll(".priority-select"),l=null;n.forEach(a=>{a!==o&&a.value===s&&(l=a)}),l&&(l.value=t,l.setAttribute("data-current-value",t)),o.setAttribute("data-current-value",s)}function H(e){return["\u5317\u6D77\u9053","\u9752\u68EE\u770C","\u5CA9\u624B\u770C","\u5BAE\u57CE\u770C","\u79CB\u7530\u770C","\u5C71\u5F62\u770C","\u798F\u5CF6\u770C","\u8328\u57CE\u770C","\u6803\u6728\u770C","\u7FA4\u99AC\u770C","\u57FC\u7389\u770C","\u5343\u8449\u770C","\u6771\u4EAC\u90FD","\u795E\u5948\u5DDD\u770C","\u65B0\u6F5F\u770C","\u5BCC\u5C71\u770C","\u77F3\u5DDD\u770C","\u798F\u4E95\u770C","\u5C71\u68A8\u770C","\u9577\u91CE\u770C","\u5C90\u961C\u770C","\u9759\u5CA1\u770C","\u611B\u77E5\u770C","\u4E09\u91CD\u770C","\u6ECB\u8CC0\u770C","\u4EAC\u90FD\u5E9C","\u5927\u962A\u5E9C","\u5175\u5EAB\u770C","\u5948\u826F\u770C","\u548C\u6B4C\u5C71\u770C","\u9CE5\u53D6\u770C","\u5CF6\u6839\u770C","\u5CA1\u5C71\u770C","\u5E83\u5CF6\u770C","\u5C71\u53E3\u770C","\u5FB3\u5CF6\u770C","\u9999\u5DDD\u770C","\u611B\u5A9B\u770C","\u9AD8\u77E5\u770C","\u798F\u5CA1\u770C","\u4F50\u8CC0\u770C","\u9577\u5D0E\u770C","\u718A\u672C\u770C","\u5927\u5206\u770C","\u5BAE\u5D0E\u770C","\u9E7F\u5150\u5CF6\u770C","\u6C96\u7E04\u770C"].map(s=>`<option value="${s}" ${e===s?"selected":""}>${s}</option>`).join("")}function y(e=null){let s=c.getState().studentCount+1;c.setState({studentCount:s});let t="student_"+s,n=e&&(e.postalCode||e.prefecture||e.city||e.street),l=`
    <div class="student-card fade-in" id="${t}">
      <input type="hidden" name="studentId_${t}" value="${e&&e.studentId||""}">
      <div class="card-header">
        <h3>\u751F\u5F92${s}</h3>
        ${s>1?`<button type="button" class="btn btn-danger btn-sm remove-btn" data-remove-student="${t}">\u524A\u9664</button>`:""}
      </div>
      
      <div class="form-row">



        <div class="form-group col-md-6">
          <label>\u59D3 <span class="required">*</span></label>
          <input type="text" class="form-control" name="s_last_name_${t}" value="${e?e.lastName:""}" required>
        </div>
        <div class="form-group col-md-6">
          <label>\u540D <span class="required">*</span></label>
          <input type="text" class="form-control" name="s_first_name_${t}" value="${e?e.firstName:""}" required>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group col-md-6">
          <label>\u30D5\u30EA\u30AC\u30CA\uFF08\u59D3\uFF09 <span class="required">*</span></label>
          <input type="text" class="form-control" name="s_last_name_kana_${t}" value="${e?e.lastNameKana:""}" pattern="[\u30A1-\u30F6\u30FC]+" required>
        </div>
        <div class="form-group col-md-6">
          <label>\u30D5\u30EA\u30AC\u30CA\uFF08\u540D\uFF09 <span class="required">*</span></label>
          <input type="text" class="form-control" name="s_first_name_kana_${t}" value="${e?e.firstNameKana:""}" pattern="[\u30A1-\u30F6\u30FC]+" required>
        </div>
      </div>
      
      <div class="form-group">
        <label>\u9AD8\u6821\u5352\u696D\uFF08\u4E88\u5B9A\uFF09\u5E74 <span class="required">*</span></label>
        <select class="form-control" name="graduation_year_${t}" required>
          <option value="">\u9078\u629E</option>
          ${T(e?e.graduationYear:null)}
        </select>
      </div>
      
      <div class="form-group">
        <label>\u9023\u7D61\u7528\u30E1\u30FC\u30EB\u30A2\u30C9\u30EC\u30B9 <span class="required">*</span></label>
        <input type="email" class="form-control" name="s_email_${t}" value="${e?e.email:""}" required>
      </div>
      
      <div class="form-group">
        <label>\u30AA\u30F3\u30E9\u30A4\u30F3\u6388\u696D\u7528\u30E1\u30FC\u30EB\u30A2\u30C9\u30EC\u30B9\uFF08\u4EFB\u610F\uFF09</label>
        <input type="email" class="form-control" name="s_class_email_${t}" value="${e&&e.classEmail||""}">
        <small class="form-text">\u{1F4A1} PC/\u30BF\u30D6\u30EC\u30C3\u30C8\u3067\u78BA\u8A8D\u3057\u3084\u3059\u3044\u30E1\u30FC\u30EB\u30A2\u30C9\u30EC\u30B9\u63A8\u5968</small>
      </div>
      
      <div class="form-group">
        <label>\u643A\u5E2F\u96FB\u8A71\u756A\u53F7\uFF08\u4EFB\u610F\uFF09</label>
        <input type="tel" class="form-control" name="s_mobile_phone_${t}" value="${e&&e.mobilePhone||""}" placeholder="090-1234-5678">
        <small class="form-text">\u{1F4F1} \u304A\u6301\u3061\u306E\u5834\u5408\u306F\u5FC5\u305A\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044</small>
      </div>

       <!-- Address Input -->
      <div class="form-group mt-3">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="separate_address_s_${t}" data-toggle-address="s_${t}" ${n?"checked":""}>
          <label class="form-check-label" for="separate_address_s_${t}">
            \u3054\u81EA\u5B85\u3068\u7570\u306A\u308B\u4F4F\u6240\u3092\u767B\u9332\u3059\u308B\uFF08\u5BEE\u751F\u6D3B\u7B49\uFF09
          </label>
        </div>
      </div>
      
      <div id="address_fields_s_${t}" style="display: ${n?"block":"none"};" class="bg-light p-3 rounded">
        <div class="form-row">
          <div class="form-group col-md-4">
            <label>\u90F5\u4FBF\u756A\u53F7</label>
            <input type="text" id="postalCode_s_${t}" name="postalCode_s_${t}" class="form-control" placeholder="123-4567" maxlength="8" value="${e&&e.postalCode||""}">
            <button type="button" class="btn btn-sm btn-secondary mt-1" data-search-address="s_${t}">\u4F4F\u6240\u691C\u7D22</button>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group col-md-4">
            <label>\u90FD\u9053\u5E9C\u770C</label>
            <select id="prefecture_s_${t}" name="prefecture_s_${t}" class="form-control">
              <option value="">\u9078\u629E</option>
              ${G(e?e.prefecture:"")}
            </select>
          </div>
          <div class="form-group col-md-8">
            <label>\u5E02\u533A\u753A\u6751</label>
            <input type="text" id="city_s_${t}" name="city_s_${t}" class="form-control" value="${e&&e.city||""}">
          </div>
        </div>
        <div class="form-group">
          <label>\u753A\u540D\u30FB\u756A\u5730\u30FB\u53F7</label>
          <input type="text" id="street_s_${t}" name="street_s_${t}" class="form-control" value="${e&&e.street||""}">
        </div>
        <div class="form-group">
          <label>\u5EFA\u7269\u540D\u30FB\u90E8\u5C4B\u756A\u53F7</label>
          <input type="text" id="building_s_${t}" name="building_s_${t}" class="form-control" value="${e&&e.building||""}">
        </div>
      </div>
    </div>
  `;document.getElementById("studentsList").insertAdjacentHTML("beforeend",l)}function x(e){confirm("\u3053\u306E\u751F\u5F92\u3092\u524A\u9664\u3057\u307E\u3059\u304B\uFF1F")&&document.getElementById(e).remove()}function T(e){let o=new Date().getFullYear(),s=[];for(let t=-5;t<=10;t++){let n=o+t,l=e&&e==n?"selected":"";s.push(`<option value="${n}" ${l}>${n}\u5E74</option>`)}return s.join("")}function G(e){return["\u5317\u6D77\u9053","\u9752\u68EE\u770C","\u5CA9\u624B\u770C","\u5BAE\u57CE\u770C","\u79CB\u7530\u770C","\u5C71\u5F62\u770C","\u798F\u5CF6\u770C","\u8328\u57CE\u770C","\u6803\u6728\u770C","\u7FA4\u99AC\u770C","\u57FC\u7389\u770C","\u5343\u8449\u770C","\u6771\u4EAC\u90FD","\u795E\u5948\u5DDD\u770C","\u65B0\u6F5F\u770C","\u5BCC\u5C71\u770C","\u77F3\u5DDD\u770C","\u798F\u4E95\u770C","\u5C71\u68A8\u770C","\u9577\u91CE\u770C","\u5C90\u961C\u770C","\u9759\u5CA1\u770C","\u611B\u77E5\u770C","\u4E09\u91CD\u770C","\u6ECB\u8CC0\u770C","\u4EAC\u90FD\u5E9C","\u5927\u962A\u5E9C","\u5175\u5EAB\u770C","\u5948\u826F\u770C","\u548C\u6B4C\u5C71\u770C","\u9CE5\u53D6\u770C","\u5CF6\u6839\u770C","\u5CA1\u5C71\u770C","\u5E83\u5CF6\u770C","\u5C71\u53E3\u770C","\u5FB3\u5CF6\u770C","\u9999\u5DDD\u770C","\u611B\u5A9B\u770C","\u9AD8\u77E5\u770C","\u798F\u5CA1\u770C","\u4F50\u8CC0\u770C","\u9577\u5D0E\u770C","\u718A\u672C\u770C","\u5927\u5206\u770C","\u5BAE\u5D0E\u770C","\u9E7F\u5150\u5CF6\u770C","\u6C96\u7E04\u770C"].map(s=>`<option value="${s}" ${e===s?"selected":""}>${s}</option>`).join("")}function u(e){let o=document.getElementById("loading"),s=document.getElementById("registrationForm");o&&(o.style.display=e?"block":"none"),s&&(s.style.display=e?"none":"block")}function d(e,o){let s=document.getElementById("message");s&&(s.className="alert alert-"+o,s.textContent=e,s.style.display="block",o==="success"&&setTimeout(()=>{s.style.display="none"},3e3))}function _(){let e=document.querySelector('input[name="mode"]:checked');if(!e)return;let o=e.value;c.setState({mode:o});let s=document.getElementById("editAuthSection"),t=document.getElementById("householdSection"),n=document.getElementById("guardiansSection"),l=document.getElementById("studentsSection"),a=document.getElementById("notesSection"),r=document.getElementById("submitSection");if(o==="new"){s&&(s.style.display="none"),t&&(t.style.display="block"),n&&(n.style.display="block"),l&&(l.style.display="block"),a&&(a.style.display="block"),r&&(r.style.display="block");let i=c.getState();i.guardianCount===0&&g(),i.studentCount===0&&y()}else s&&(s.style.display="block"),t&&(t.style.display="none"),n&&(n.style.display="none"),l&&(l.style.display="none"),a&&(a.style.display="none"),r&&(r.style.display="none")}function q(){return p(this,null,function*(){let e=document.getElementById("authEmail").value.trim(),o=document.getElementById("editCode").value.trim();if(!e){d("\u30E1\u30FC\u30EB\u30A2\u30C9\u30EC\u30B9\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044\u3002","danger");return}if(!o){d("\u7DE8\u96C6\u30B3\u30FC\u30C9\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044\u3002","danger");return}u(!0);try{let s=yield f("authenticateWithEditCode",e,o);if(console.log("authenticateWithEditCode result:",s),u(!1),!s)throw new Error("\u30B5\u30FC\u30D0\u30FC\u304B\u3089\u306E\u5FDC\u7B54\u304C\u3042\u308A\u307E\u305B\u3093\u3002");if(s.success){let t=s.householdData;if(typeof t=="string")try{t=JSON.parse(t)}catch(n){console.error("Failed to parse householdData JSON:",n)}j(t),d("\u8A8D\u8A3C\u306B\u6210\u529F\u3057\u307E\u3057\u305F\u3002","success")}else d(s.message,"danger")}catch(s){u(!1),console.error("Authentication error:",s),d("\u30A8\u30E9\u30FC\u304C\u767A\u751F\u3057\u307E\u3057\u305F: "+s.message,"danger")}})}function w(){return p(this,null,function*(){let e=document.getElementById("authEmail").value.trim();if(!e){d("\u30E1\u30FC\u30EB\u30A2\u30C9\u30EC\u30B9\u3092\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044\u3002","danger");return}u(!0);try{let o=yield f("requestMagicLink",e);u(!1),o.success?d(o.message,"success"):d(o.message,"danger")}catch(o){u(!1),d("\u30A8\u30E9\u30FC\u304C\u767A\u751F\u3057\u307E\u3057\u305F: "+o.message,"danger")}})}function j(e){let o=document.getElementById("editAuthSection");o&&(o.style.display="none");let s=document.querySelectorAll(".form-section");s.length>0&&(s[0].style.display="none"),document.getElementById("householdSection").style.display="block",document.getElementById("guardiansSection").style.display="block",document.getElementById("studentsSection").style.display="block",document.getElementById("notesSection").style.display="block",document.getElementById("submitSection").style.display="block";let t=document.querySelector('#submitSection button[type="submit"]');if(t&&(t.textContent="\u66F4\u65B0"),c.setState({mode:"edit"}),e.household){let n=e.household;c.setState({householdId:n.householdId}),document.getElementById("postalCode").value=n.postalCode||"",document.getElementById("prefecture").value=n.prefecture||"",document.getElementById("city").value=n.city||"",document.getElementById("street").value=n.street||"",document.getElementById("building").value=n.building||"",document.getElementById("notes").value=n.notes||""}document.getElementById("guardiansList").innerHTML="",c.setState({guardianCount:0}),e.guardians&&e.guardians.length>0&&e.guardians.forEach(n=>{g(n)}),document.getElementById("studentsList").innerHTML="",c.setState({studentCount:0}),e.students&&e.students.length>0&&e.students.forEach(n=>{y(n)})}function O(){let e={household:{postalCode:document.getElementById("postalCode").value,prefecture:document.getElementById("prefecture").value,city:document.getElementById("city").value,street:document.getElementById("street").value,building:document.getElementById("building").value,notes:document.getElementById("notes").value},guardians:[],students:[]};return document.querySelectorAll(".guardian-card").forEach(o=>{let s=o.id,t=a=>{let r=o.querySelector(`[name="${a}"]`);return r?r.value:""},n=document.getElementById(`separate_address_${s}`),l=n&&n.checked;e.guardians.push({guardianId:t(`guardianId_${s}`),relationship:t(`relationship_${s}`),contactPriority:t(`priority_${s}`)?parseInt(t(`priority_${s}`)):"",contactMethod:t(`contact_method_${s}`),lastName:t(`last_name_${s}`),firstName:t(`first_name_${s}`),lastNameKana:t(`last_name_kana_${s}`),firstNameKana:t(`first_name_kana_${s}`),email:t(`email_${s}`),meetingEmail:t(`meeting_email_${s}`),mobilePhone:t(`mobile_phone_${s}`),homePhone:t(`home_phone_${s}`),postalCode:l?t(`postalCode_${s}`):"",prefecture:l?t(`prefecture_${s}`):"",city:l?t(`city_${s}`):"",street:l?t(`street_${s}`):"",building:l?t(`building_${s}`):""})}),document.querySelectorAll(".student-card").forEach(o=>{let s=o.id,t=a=>{let r=o.querySelector(`[name="${a}"]`);return r?r.value:""},n=document.getElementById(`separate_address_s_${s}`),l=n&&n.checked;e.students.push({studentId:t(`studentId_${s}`),lastName:t(`s_last_name_${s}`),firstName:t(`s_first_name_${s}`),lastNameKana:t(`s_last_name_kana_${s}`),firstNameKana:t(`s_first_name_kana_${s}`),graduationYear:t(`graduation_year_${s}`),email:t(`s_email_${s}`),classEmail:t(`s_class_email_${s}`),mobilePhone:t(`s_mobile_phone_${s}`),postalCode:l?t(`postalCode_s_${s}`):"",prefecture:l?t(`prefecture_s_${s}`):"",city:l?t(`city_s_${s}`):"",street:l?t(`street_s_${s}`):"",building:l?t(`building_s_${s}`):""})}),e}var v=null;function V(e){v=e;let o=document.getElementById("confirmationContent");if(!o)return;let s='<div class="confirmation-details">';s+="<h3>\u{1F4CD} \u3054\u81EA\u5B85\u4F4F\u6240</h3>",s+=`<p>\u3012${e.household.postalCode}<br>`,s+=`${e.household.prefecture} ${e.household.city} ${e.household.street} ${e.household.building}</p>`,e.household.notes&&(s+=`<p><strong>\u5099\u8003:</strong><br>${e.household.notes.replace(/\n/g,"<br>")}</p>`),s+="<hr>",s+="<h3>\u{1F468}\u200D\u{1F469}\u200D\u{1F467}\u200D\u{1F466} \u4FDD\u8B77\u8005\u60C5\u5831</h3>",e.guardians.forEach((t,n)=>{s+=`<div class="mb-3"><strong>\u4FDD\u8B77\u8005${n+1}: ${t.lastName} ${t.firstName}</strong>`,s+=`<br>\u30AB\u30CA: ${t.lastNameKana} ${t.firstNameKana}`,s+=`<br>\u7D9A\u67C4: ${t.relationship}`,s+=`<br>\u9023\u7D61\u512A\u5148\u9806\u4F4D: ${t.contactPriority}\u4F4D`,s+=`<br>\u9023\u7D61\u65B9\u6CD5: ${t.contactMethod}`,t.mobilePhone&&(s+=`<br>\u643A\u5E2F\u96FB\u8A71: ${t.mobilePhone}`),t.homePhone&&(s+=`<br>\u81EA\u5B85\u96FB\u8A71: ${t.homePhone}`),s+=`<br>Email: ${t.email}`,t.meetingEmail&&(s+=`<br>\u30AA\u30F3\u30E9\u30A4\u30F3\u9762\u8AC7\u7528Email: ${t.meetingEmail}`),t.postalCode?s+=`<br>\u4F4F\u6240: \u3012${t.postalCode} ${t.prefecture} ${t.city} ${t.street} ${t.building}`:s+="<br>\u4F4F\u6240: \u3054\u81EA\u5B85\u3068\u540C\u3058",s+="</div>"}),s+="<hr>",s+="<h3>\u{1F468}\u200D\u{1F393} \u751F\u5F92\u60C5\u5831</h3>",e.students.forEach((t,n)=>{s+=`<div class="mb-3"><strong>\u751F\u5F92${n+1}: ${t.lastName} ${t.firstName}</strong>`,s+=`<br>\u30AB\u30CA: ${t.lastNameKana} ${t.firstNameKana}`,s+=`<br>\u5352\u696D\u4E88\u5B9A: ${t.graduationYear}\u5E743\u6708`,t.email&&(s+=`<br>Email: ${t.email}`),t.classEmail&&(s+=`<br>Classroom\u7528Email: ${t.classEmail}`),t.mobilePhone&&(s+=`<br>\u643A\u5E2F\u96FB\u8A71: ${t.mobilePhone}`),t.postalCode?s+=`<br>\u4F4F\u6240: \u3012${t.postalCode} ${t.prefecture} ${t.city} ${t.street} ${t.building}`:s+="<br>\u4F4F\u6240: \u3054\u81EA\u5B85\u3068\u540C\u3058",s+="</div>"}),s+="</div>",o.innerHTML=s,document.getElementById("registrationForm").style.display="none",document.getElementById("confirmationSection").style.display="block",window.scrollTo(0,0)}function A(){document.getElementById("confirmationSection").style.display="none",document.getElementById("registrationForm").style.display="block",window.scrollTo(0,0)}function N(){return p(this,null,function*(){if(v){u(!0),document.getElementById("confirmationSection").style.display="none";try{let e=c.getState(),o;if(e.mode==="edit"){if(!e.householdId)throw new Error("\u4E16\u5E2FID\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093\u3002");o=yield f("updateHouseholdData",e.householdId,v)}else o=yield f("submitRegistration",v);u(!1),o.success?(d(o.message,"success"),document.getElementById("confirmationSection").innerHTML=`
        <div class="text-center py-5">
          <h2 class="text-success mb-4">\u9001\u4FE1\u5B8C\u4E86</h2>
          <p>${o.message}</p>
          <p>\u3053\u306E\u753B\u9762\u3092\u9589\u3058\u3066\u304F\u3060\u3055\u3044\u3002</p>
        </div>
      `,document.getElementById("confirmationSection").style.display="block"):(d(o.message,"danger"),document.getElementById("registrationForm").style.display="block")}catch(e){u(!1),d("\u30A8\u30E9\u30FC\u304C\u767A\u751F\u3057\u307E\u3057\u305F: "+e.message,"danger"),document.getElementById("registrationForm").style.display="block"}}})}function P(e){return p(this,null,function*(){e.preventDefault();let o=I();if(!o.valid){o.message&&d(o.message,"danger");return}let s=O();V(s)})}function h(e,o,s,t){return p(this,null,function*(){let n=document.getElementById(e);if(!n)return;let l=n.value.replace(/-/g,"");if(l.length!==7){d("\u90F5\u4FBF\u756A\u53F7\u306F7\u6841\u3067\u5165\u529B\u3057\u3066\u304F\u3060\u3055\u3044\u3002","danger");return}u(!0);try{let r=yield(yield fetch("https://zipcloud.ibsnet.co.jp/api/search?zipcode="+l)).json();if(u(!1),r.results){let i=r.results[0];document.getElementById(o).value=i.address1,document.getElementById(s).value=i.address2,document.getElementById(t).value=i.address3,d("\u4F4F\u6240\u3092\u81EA\u52D5\u5165\u529B\u3057\u307E\u3057\u305F\u3002","success")}else d("\u90F5\u4FBF\u756A\u53F7\u304C\u898B\u3064\u304B\u308A\u307E\u305B\u3093\u3067\u3057\u305F\u3002","danger")}catch(a){u(!1),console.error("\u4F4F\u6240\u691C\u7D22\u30A8\u30E9\u30FC:",a),d("\u4F4F\u6240\u691C\u7D22\u306B\u5931\u6557\u3057\u307E\u3057\u305F\u3002","danger")}})}function L(e){let o=document.getElementById(`separate_address_${e}`),s=document.getElementById(`address_fields_${e}`);o&&s&&(s.style.display=o.checked?"block":"none")}window.addGuardian=g;window.addStudent=y;window.authenticateEdit=q;window.requestMagicLink=w;window.handleBack=A;window.handleFinalSubmit=N;window.onerror=function(e,o,s){return alert(`System Error (Please report this):
`+e+`
Line: `+s),!1};document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll('input[name="mode"]').forEach(s=>{s.addEventListener("change",_)}),_();let e=document.getElementById("registrationForm");e&&e.addEventListener("submit",P);let o=document.getElementById("searchAddressBtn");o&&o.addEventListener("click",()=>{h("postalCode","prefecture","city","street")}),document.addEventListener("click",s=>{let t=s.target;if(t.matches("[data-remove-guardian]")){let n=t.getAttribute("data-remove-guardian");B(n)}if(t.matches("[data-remove-student]")){let n=t.getAttribute("data-remove-student");x(n)}if(t.matches("[data-search-address]")){let n=t.getAttribute("data-search-address");n.startsWith("s_")?h(`postalCode_${n}`,`prefecture_${n}`,`city_${n}`,`street_${n}`):h(`postalCode_${n}`,`prefecture_${n}`,`city_${n}`,`street_${n}`)}}),document.addEventListener("change",s=>{let t=s.target;if(t.matches("[data-toggle-address]")){let n=t.getAttribute("data-toggle-address");L(n)}t.matches(".priority-select")&&k(s)})});})();

</script>