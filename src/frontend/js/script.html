<script>
  let guardianCount = 0;
  let studentCount = 0;
  let currentMode = 'new';

  // ============================================
  // åˆæœŸåŒ–
  // ============================================
  document.addEventListener('DOMContentLoaded', function () {
    // ãƒ¢ãƒ¼ãƒ‰é¸æŠã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
    document.querySelectorAll('input[name="mode"]').forEach(radio => {
      radio.addEventListener('change', handleModeChange);
    });

    // åˆæœŸãƒ¢ãƒ¼ãƒ‰ã®è¨­å®š
    currentMode = document.querySelector('input[name="mode"]:checked').value;
    handleModeChange();

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('registrationForm').addEventListener('submit', handleSubmit);
  });

  // ============================================
  // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
  // ============================================
  function handleModeChange() {
    const mode = document.querySelector('input[name="mode"]:checked').value;
    currentMode = mode;

    const editAuthSection = document.getElementById('editAuthSection');
    const householdSection = document.getElementById('householdSection');
    const guardiansSection = document.getElementById('guardiansSection');
    const studentsSection = document.getElementById('studentsSection');
    const notesSection = document.getElementById('notesSection');
    const submitSection = document.getElementById('submitSection');

    if (mode === 'new') {
      editAuthSection.style.display = 'none';
      householdSection.style.display = 'block';
      guardiansSection.style.display = 'block';
      studentsSection.style.display = 'block';
      notesSection.style.display = 'block';
      submitSection.style.display = 'block';

      // åˆæœŸãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã€1äººãšã¤è¿½åŠ 
      if (guardianCount === 0) addGuardian();
      if (studentCount === 0) addStudent();
    } else {
      editAuthSection.style.display = 'block';
      householdSection.style.display = 'none';
      guardiansSection.style.display = 'none';
      studentsSection.style.display = 'none';
      notesSection.style.display = 'none';
      submitSection.style.display = 'none';
    }
  }

  // ============================================
  // ç·¨é›†èªè¨¼
  // ============================================
  function authenticateEdit() {
    const email = document.getElementById('authEmail').value.trim();
    const editCode = document.getElementById('editCode').value.trim();

    if (!email) {
      showMessage('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'danger');
      return;
    }

    if (!editCode) {
      showMessage('ç·¨é›†ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'danger');
      return;
    }

    showLoading(true);

    google.script.run
      .withSuccessHandler(function (result) {
        showLoading(false);
        if (result.success) {
          loadHouseholdData(result.householdData);
          showMessage('èªè¨¼ã«æˆåŠŸã—ã¾ã—ãŸã€‚', 'success');
        } else {
          showMessage(result.message, 'danger');
        }
      })
      .withFailureHandler(function (error) {
        showLoading(false);
        showMessage('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'danger');
      })
      .authenticateWithEditCode(email, editCode);
  }

  // ============================================
  // Magic Linké€ä¿¡
  // ============================================
  function requestMagicLink() {
    const email = document.getElementById('authEmail').value.trim();

    if (!email) {
      showMessage('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'danger');
      return;
    }

    showLoading(true);

    google.script.run
      .withSuccessHandler(function (result) {
        showLoading(false);
        if (result.success) {
          showMessage(result.message, 'success');
        } else {
          showMessage(result.message, 'danger');
        }
      })
      .withFailureHandler(function (error) {
        showLoading(false);
        showMessage('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'danger');
      })
      .requestMagicLink(email);
  }

  // ============================================
  // ä¸–å¸¯ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
  // ============================================
  function loadHouseholdData(householdData) {
    // ãƒ¢ãƒ¼ãƒ‰ã‚’æ–°è¦ç™»éŒ²ã«åˆ‡ã‚Šæ›¿ãˆ
    document.querySelector('input[name="mode"][value="new"]').checked = true;
    handleModeChange();

    // ä¸–å¸¯æƒ…å ±
    if (householdData.household) {
      const h = householdData.household;
      document.getElementById('postalCode').value = h.postalCode || '';
      document.getElementById('prefecture').value = h.prefecture || '';
      document.getElementById('city').value = h.city || '';
      document.getElementById('street').value = h.street || '';
      document.getElementById('building').value = h.building || '';
      document.getElementById('notes').value = h.notes || '';
    }

    // ä¿è­·è€…æƒ…å ±
    document.getElementById('guardiansList').innerHTML = '';
    guardianCount = 0;
    if (householdData.guardians && householdData.guardians.length > 0) {
      householdData.guardians.forEach(guardian => {
        addGuardian(guardian);
      });
    }

    // ç”Ÿå¾’æƒ…å ±
    document.getElementById('studentsList').innerHTML = '';
    studentCount = 0;
    if (householdData.students && householdData.students.length > 0) {
      householdData.students.forEach(student => {
        addStudent(student);
      });
    }
  }

  // ============================================
  // ä¿è­·è€…è¿½åŠ 
  // ============================================
  function addGuardian(data = null) {
    guardianCount++;
    const id = 'guardian_' + guardianCount;

    const html = `
    <div class="guardian-card fade-in" id="${id}">
      <div class="card-header">
        <h3>ä¿è­·è€…${guardianCount}</h3>
        ${guardianCount > 1 ? `<button type="button" class="btn btn-danger btn-sm remove-btn" onclick="removeGuardian('${id}')">å‰Šé™¤</button>` : ''}
      </div>
      
      <div class="form-row">
        <div class="form-group col-md-4">
          <label>ç¶šæŸ„ <span class="required">*</span></label>
          <select class="form-control" name="relationship_${id}" required>
            <option value="">é¸æŠ</option>
            <option value="çˆ¶" ${data && data.relationship === 'çˆ¶' ? 'selected' : ''}>çˆ¶</option>
            <option value="æ¯" ${data && data.relationship === 'æ¯' ? 'selected' : ''}>æ¯</option>
            <option value="ç¥–çˆ¶" ${data && data.relationship === 'ç¥–çˆ¶' ? 'selected' : ''}>ç¥–çˆ¶</option>
            <option value="ç¥–æ¯" ${data && data.relationship === 'ç¥–æ¯' ? 'selected' : ''}>ç¥–æ¯</option>
            <option value="ãã®ä»–" ${data && data.relationship === 'ãã®ä»–' ? 'selected' : ''}>ãã®ä»–</option>
          </select>
        </div>
        <div class="form-group col-md-4">
          <label>é€£çµ¡å„ªå…ˆé †ä½ <span class="required">*</span></label>
          <select class="form-control" name="priority_${id}" required>
            ${[1, 2, 3, 4, 5].map(n => `<option value="${n}" ${data && data.contactPriority === n ? 'selected' : ''}>${n}</option>`).join('')}
          </select>
        </div>
        <div class="form-group col-md-4">
          <label>é€£çµ¡æ‰‹æ®µ</label>
          <select class="form-control" name="contact_method_${id}">
            <option value="é›»è©±" ${!data || data.contactMethod === 'é›»è©±' ? 'selected' : ''}>é›»è©±</option>
            <option value="ãƒ¡ãƒ¼ãƒ«" ${data && data.contactMethod === 'ãƒ¡ãƒ¼ãƒ«' ? 'selected' : ''}>ãƒ¡ãƒ¼ãƒ«</option>
          </select>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group col-md-6">
          <label>å§“ <span class="required">*</span></label>
          <input type="text" class="form-control" name="last_name_${id}" value="${data ? data.lastName : ''}" required>
        </div>
        <div class="form-group col-md-6">
          <label>å <span class="required">*</span></label>
          <input type="text" class="form-control" name="first_name_${id}" value="${data ? data.firstName : ''}" required>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group col-md-6">
          <label>ãƒ•ãƒªã‚¬ãƒŠï¼ˆå§“ï¼‰ <span class="required">*</span></label>
          <input type="text" class="form-control" name="last_name_kana_${id}" value="${data ? data.lastNameKana : ''}" pattern="[ã‚¡-ãƒ¶ãƒ¼]+" required>
        </div>
        <div class="form-group col-md-6">
          <label>ãƒ•ãƒªã‚¬ãƒŠï¼ˆåï¼‰ <span class="required">*</span></label>
          <input type="text" class="form-control" name="first_name_kana_${id}" value="${data ? data.firstNameKana : ''}" pattern="[ã‚¡-ãƒ¶ãƒ¼]+" required>
        </div>
      </div>
      
      <div class="form-group">
        <label>é€£çµ¡ç”¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ <span class="required">*</span></label>
        <input type="email" class="form-control" name="email_${id}" value="${data ? data.email : ''}" required>
      </div>
      
      <div class="form-group">
        <label>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³é¢è«‡ç”¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä»»æ„ï¼‰</label>
        <input type="email" class="form-control" name="meeting_email_${id}" value="${data ? data.meetingEmail || '' : ''}">
        <small class="form-text">ğŸ’¡ PC/ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ç¢ºèªã—ã‚„ã™ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ¨å¥¨</small>
      </div>
      
      <div class="form-row">
        <div class="form-group col-md-6">
          <label>æºå¸¯é›»è©±ç•ªå·</label>
          <input type="tel" class="form-control" name="mobile_phone_${id}" value="${data ? data.mobilePhone || '' : ''}" placeholder="090-1234-5678">
        </div>
        <div class="form-group col-md-6">
          <label>è‡ªå®…é›»è©±ç•ªå·</label>
          <input type="tel" class="form-control" name="home_phone_${id}" value="${data ? data.homePhone || '' : ''}" placeholder="03-1234-5678">
        </div>
      </div>
      <small class="form-text">ğŸ“ æºå¸¯é›»è©±ã¾ãŸã¯è‡ªå®…é›»è©±ã®ã©ã¡ã‚‰ã‹1ã¤ã¯å¿…ãšå…¥åŠ›ã—ã¦ãã ã•ã„</small>
    </div>
  `;

    document.getElementById('guardiansList').insertAdjacentHTML('beforeend', html);
  }

  // ============================================
  // ä¿è­·è€…å‰Šé™¤
  // ============================================
  function removeGuardian(id) {
    if (confirm('ã“ã®ä¿è­·è€…ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      document.getElementById(id).remove();
    }
  }

  // ============================================
  // ç”Ÿå¾’è¿½åŠ 
  // ============================================
  function addStudent(data = null) {
    studentCount++;
    const id = 'student_' + studentCount;

    const html = `
    <div class="student-card fade-in" id="${id}">
      <div class="card-header">
        <h3>ç”Ÿå¾’${studentCount}</h3>
        ${studentCount > 1 ? `<button type="button" class="btn btn-danger btn-sm remove-btn" onclick="removeStudent('${id}')">å‰Šé™¤</button>` : ''}
      </div>
      
      <div class="form-row">
        <div class="form-group col-md-6">
          <label>å§“ <span class="required">*</span></label>
          <input type="text" class="form-control" name="s_last_name_${id}" value="${data ? data.lastName : ''}" required>
        </div>
        <div class="form-group col-md-6">
          <label>å <span class="required">*</span></label>
          <input type="text" class="form-control" name="s_first_name_${id}" value="${data ? data.firstName : ''}" required>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group col-md-6">
          <label>ãƒ•ãƒªã‚¬ãƒŠï¼ˆå§“ï¼‰ <span class="required">*</span></label>
          <input type="text" class="form-control" name="s_last_name_kana_${id}" value="${data ? data.lastNameKana : ''}" pattern="[ã‚¡-ãƒ¶ãƒ¼]+" required>
        </div>
        <div class="form-group col-md-6">
          <label>ãƒ•ãƒªã‚¬ãƒŠï¼ˆåï¼‰ <span class="required">*</span></label>
          <input type="text" class="form-control" name="s_first_name_kana_${id}" value="${data ? data.firstNameKana : ''}" pattern="[ã‚¡-ãƒ¶ãƒ¼]+" required>
        </div>
      </div>
      
      <div class="form-group">
        <label>é«˜æ ¡å’æ¥­ï¼ˆäºˆå®šï¼‰å¹´ <span class="required">*</span></label>
        <select class="form-control" name="graduation_year_${id}" required>
          <option value="">é¸æŠ</option>
          ${generateYearOptions(data ? data.graduationYear : null)}
        </select>
      </div>
      
      <div class="form-group">
        <label>é€£çµ¡ç”¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ <span class="required">*</span></label>
        <input type="email" class="form-control" name="s_email_${id}" value="${data ? data.email : ''}" required>
      </div>
      
      <div class="form-group">
        <label>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æˆæ¥­ç”¨ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä»»æ„ï¼‰</label>
        <input type="email" class="form-control" name="s_class_email_${id}" value="${data ? data.classEmail || '' : ''}">
        <small class="form-text">ğŸ’¡ PC/ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã§ç¢ºèªã—ã‚„ã™ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ¨å¥¨</small>
      </div>
      
      <div class="form-group">
        <label>æºå¸¯é›»è©±ç•ªå·ï¼ˆä»»æ„ï¼‰</label>
        <input type="tel" class="form-control" name="s_mobile_phone_${id}" value="${data ? data.mobilePhone || '' : ''}" placeholder="090-1234-5678">
        <small class="form-text">ğŸ“± ãŠæŒã¡ã®å ´åˆã¯å¿…ãšå…¥åŠ›ã—ã¦ãã ã•ã„</small>
      </div>
    </div>
  `;

    document.getElementById('studentsList').insertAdjacentHTML('beforeend', html);
  }

  // ============================================
  // ç”Ÿå¾’å‰Šé™¤
  // ============================================
  function removeStudent(id) {
    if (confirm('ã“ã®ç”Ÿå¾’ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      document.getElementById(id).remove();
    }
  }

  // ============================================
  // å’æ¥­å¹´ç”Ÿæˆ
  // ============================================
  function generateYearOptions(selectedYear) {
    const currentYear = new Date().getFullYear();
    const years = [];
    for (let i = -5; i <= 10; i++) {
      const year = currentYear + i;
      const selected = selectedYear && selectedYear === year.toString() ? 'selected' : '';
      years.push(`<option value="${year}" ${selected}>${year}å¹´</option>`);
    }
    return years.join('');
  }

  // ============================================
  // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
  // ============================================
  function handleSubmit(e) {
    e.preventDefault();

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!validateForm()) {
      return;
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
    const formData = collectFormData();

    showLoading(true);

    google.script.run
      .withSuccessHandler(function (result) {
        showLoading(false);
        if (result.success) {
          showMessage(result.message, 'success');
          // å®Œäº†ç”»é¢ã¸é·ç§»ï¼ˆå®Ÿè£…äºˆå®šï¼‰
        } else {
          showMessage(result.message, 'danger');
        }
      })
      .withFailureHandler(function (error) {
        showLoading(false);
        showMessage('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'danger');
      })
      .submitRegistration(formData);
  }

  // ============================================
  // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿åé›†
  // ============================================
  function collectFormData() {
    const formData = {
      household: {
        postalCode: document.getElementById('postalCode').value,
        prefecture: document.getElementById('prefecture').value,
        city: document.getElementById('city').value,
        street: document.getElementById('street').value,
        building: document.getElementById('building').value,
        notes: document.getElementById('notes').value
      },
      guardians: [],
      students: []
    };

    // ä¿è­·è€…ãƒ‡ãƒ¼ã‚¿åé›†
    document.querySelectorAll('.guardian-card').forEach(card => {
      const id = card.id;
      formData.guardians.push({
        relationship: card.querySelector(`[name="relationship_${id}"]`).value,
        contactPriority: parseInt(card.querySelector(`[name="priority_${id}"]`).value),
        contactMethod: card.querySelector(`[name="contact_method_${id}"]`).value,
        lastName: card.querySelector(`[name="last_name_${id}"]`).value,
        firstName: card.querySelector(`[name="first_name_${id}"]`).value,
        lastNameKana: card.querySelector(`[name="last_name_kana_${id}"]`).value,
        firstNameKana: card.querySelector(`[name="first_name_kana_${id}"]`).value,
        email: card.querySelector(`[name="email_${id}"]`).value,
        meetingEmail: card.querySelector(`[name="meeting_email_${id}"]`).value,
        mobilePhone: card.querySelector(`[name="mobile_phone_${id}"]`).value,
        homePhone: card.querySelector(`[name="home_phone_${id}"]`).value
      });
    });

    // ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿åé›†
    document.querySelectorAll('.student-card').forEach(card => {
      const id = card.id;
      formData.students.push({
        lastName: card.querySelector(`[name="s_last_name_${id}"]`).value,
        firstName: card.querySelector(`[name="s_first_name_${id}"]`).value,
        lastNameKana: card.querySelector(`[name="s_last_name_kana_${id}"]`).value,
        firstNameKana: card.querySelector(`[name="s_first_name_kana_${id}"]`).value,
        graduationYear: card.querySelector(`[name="graduation_year_${id}"]`).value,
        email: card.querySelector(`[name="s_email_${id}"]`).value,
        classEmail: card.querySelector(`[name="s_class_email_${id}"]`).value,
        mobilePhone: card.querySelector(`[name="s_mobile_phone_${id}"]`).value
      });
    });

    return formData;
  }

  // ============================================
  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  // ============================================
  function validateForm() {
    // ä¿è­·è€…ã®é›»è©±ç•ªå·ãƒã‚§ãƒƒã‚¯
    const guardians = document.querySelectorAll('.guardian-card');
    for (let card of guardians) {
      const id = card.id;
      const mobile = card.querySelector(`[name="mobile_phone_${id}"]`).value;
      const home = card.querySelector(`[name="home_phone_${id}"]`).value;

      if (!mobile && !home) {
        showMessage('ä¿è­·è€…ã®æºå¸¯é›»è©±ã¾ãŸã¯è‡ªå®…é›»è©±ã®ã©ã¡ã‚‰ã‹1ã¤ã¯å¿…é ˆã§ã™ã€‚', 'danger');
        return false;
      }
    }

    return true;
  }

  // ============================================
  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  // ============================================
  function showLoading(show) {
    document.getElementById('loading').style.display = show ? 'block' : 'none';
    document.getElementById('registrationForm').style.display = show ? 'none' : 'block';
  }

  function showMessage(message, type) {
    const messageDiv = document.getElementById('message');
    messageDiv.className = 'alert alert-' + type;
    messageDiv.textContent = message;
    messageDiv.style.display = 'block';

    // 3ç§’å¾Œã«è‡ªå‹•ã§æ¶ˆã™ï¼ˆæˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆï¼‰
    if (type === 'success') {
      setTimeout(() => {
        messageDiv.style.display = 'none';
      }, 3000);
    }
  }

  function searchAddress() {
    const postalCode = document.getElementById('postalCode').value.replace('-', '');
    if (postalCode.length !== 7) {
      showMessage('éƒµä¾¿ç•ªå·ã¯7æ¡ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'danger');
      return;
    }

    showLoading(true);

    fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${postalCode}`)
      .then(response => response.json())
      .then(data => {
        showLoading(false);
        if (data.results) {
          const result = data.results[0];
          document.getElementById('prefecture').value = result.address1;
          document.getElementById('city').value = result.address2;
          document.getElementById('street').value = result.address3;
          showMessage('ä½æ‰€ã‚’è‡ªå‹•å…¥åŠ›ã—ã¾ã—ãŸã€‚', 'success');
        } else {
          showMessage('éƒµä¾¿ç•ªå·ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', 'danger');
        }
      })
      .catch(error => {
        showLoading(false);
        showMessage('ä½æ‰€æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'danger');
      });
  }
</script>