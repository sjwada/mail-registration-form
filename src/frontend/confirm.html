<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç™»éŒ²å†…å®¹ç¢ºèª</title>
  <?!= include('frontend/css/style'); ?>
</head>

<body>
  <div class="container">
    <header>
      <h1>ç™»éŒ²å†…å®¹ç¢ºèª</h1>
      <p class="subtitle">ä»¥ä¸‹ã®å†…å®¹ã§ç™»éŒ²ã—ã¾ã™</p>
    </header>

    <main>
      <!-- ã”è‡ªå®…ä½æ‰€ -->
      <section class="form-section">
        <h2>ğŸ“ ã”è‡ªå®…ä½æ‰€</h2>
        <div class="confirm-item">
          <p class="confirm-label">éƒµä¾¿ç•ªå·</p>
          <p class="confirm-value">ã€’
            <?= household.postalCode ?>
          </p>
        </div>
        <div class="confirm-item">
          <p class="confirm-label">ä½æ‰€</p>
          <p class="confirm-value">
            <?= household.prefecture ?>
            <?= household.city ?>
            <?= household.street ?><br>
            <?= household.building ? household.building : '' ?>
          </p>
        </div>
      </section>

      <!-- é€£çµ¡å…ˆï¼ˆå„ªå…ˆé †ï¼‰ -->
      <section class="form-section">
        <h2>ğŸ“ é€£çµ¡å…ˆï¼ˆå„ªå…ˆé †ï¼‰</h2>
        <? guardians.sort((a, b) => a.contactPriority - b.contactPriority).forEach((guardian, index) => { ?>
        <div class="contact-priority-item">
          <div class="priority-badge">
            <?= guardian.contactPriority ?>ä½
          </div>
          <div class="contact-details">
            <p class="contact-name">
              <?= guardian.relationship ?>ï¼ˆ
              <?= guardian.lastName ?>
              <?= guardian.firstName ?>æ§˜ï¼‰
            </p>
            <p class="contact-method">
              <strong>é€£çµ¡æ–¹æ³•:</strong>
              <?= guardian.contactMethod ?>
            </p>
            <? if (guardian.contactMethod === 'é›»è©±') { ?>
            <p class="contact-info">
              <?= guardian.mobilePhone ? 'æºå¸¯: ' + guardian.mobilePhone : '' ?>
              <?= guardian.homePhone ? 'è‡ªå®…: ' + guardian.homePhone : '' ?>
            </p>
            <? } else { ?>
            <p class="contact-info">ãƒ¡ãƒ¼ãƒ«:
              <?= guardian.email ?>
            </p>
            <? } ?>
          </div>
        </div>
        <? }); ?>
      </section>

      <!-- ä¿è­·è€…æƒ…å ± -->
      <section class="form-section">
        <h2>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ä¿è­·è€…æƒ…å ±</h2>
        <? guardians.forEach((guardian, index) => { ?>
        <div class="info-card">
          <h3>ä¿è­·è€…
            <?= index + 1 ?>ï¼š
            <?= guardian.lastName ?>
            <?= guardian.firstName ?>
          </h3>
          <table class="info-table">
            <tr>
              <th>ãƒ•ãƒªã‚¬ãƒŠ</th>
              <td>
                <?= guardian.lastNameKana ?>
                <?= guardian.firstNameKana ?>
              </td>
            </tr>
            <tr>
              <th>ç¶šæŸ„</th>
              <td>
                <?= guardian.relationship ?>
              </td>
            </tr>
            <tr>
              <th>é€£çµ¡ç”¨ãƒ¡ãƒ¼ãƒ«</th>
              <td>
                <?= guardian.email ?>
              </td>
            </tr>
            <? if (guardian.meetingEmail) { ?>
            <tr>
              <th>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³é¢è«‡ç”¨ãƒ¡ãƒ¼ãƒ«</th>
              <td>
                <?= guardian.meetingEmail ?>
              </td>
            </tr>
            <? } ?>
            <tr>
              <th>æºå¸¯é›»è©±</th>
              <td>
                <?= guardian.mobilePhone || 'æœªç™»éŒ²' ?>
              </td>
            </tr>
            <tr>
              <th>è‡ªå®…é›»è©±</th>
              <td>
                <?= guardian.homePhone || 'æœªç™»éŒ²' ?>
              </td>
            </tr>
          </table>
        </div>
        <? }); ?>
      </section>

      <!-- ç”Ÿå¾’æƒ…å ± -->
      <section class="form-section">
        <h2>ğŸ‘¨â€ğŸ“ ç”Ÿå¾’æƒ…å ±</h2>
        <? students.forEach((student, index) => { ?>
        <div class="info-card">
          <h3>ç”Ÿå¾’
            <?= index + 1 ?>ï¼š
            <?= student.lastName ?>
            <?= student.firstName ?>
          </h3>
          <table class="info-table">
            <tr>
              <th>ãƒ•ãƒªã‚¬ãƒŠ</th>
              <td>
                <?= student.lastNameKana ?>
                <?= student.firstNameKana ?>
              </td>
            </tr>
            <tr>
              <th>é«˜æ ¡å’æ¥­äºˆå®šå¹´</th>
              <td>
                <?= student.graduationYear ?>å¹´
              </td>
            </tr>
            <tr>
              <th>é€£çµ¡ç”¨ãƒ¡ãƒ¼ãƒ«</th>
              <td>
                <?= student.email ?>
              </td>
            </tr>
            <? if (student.classEmail) { ?>
            <tr>
              <th>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³æˆæ¥­ç”¨ãƒ¡ãƒ¼ãƒ«</th>
              <td>
                <?= student.classEmail ?>
              </td>
            </tr>
            <? } ?>
            <tr>
              <th>æºå¸¯é›»è©±</th>
              <td>
                <?= student.mobilePhone || 'æœªç™»éŒ²' ?>
              </td>
            </tr>
          </table>
        </div>
        <? }); ?>
      </section>

      <!-- å‚™è€ƒ -->
      <? if (household.notes) { ?>
      <section class="form-section">
        <h2>ğŸ“ å‚™è€ƒ</h2>
        <p class="confirm-value">
          <?= household.notes ?>
        </p>
      </section>
      <? } ?>

      <!-- ãƒœã‚¿ãƒ³ -->
      <div class="button-group">
        <button type="button" class="btn btn-secondary btn-lg" onclick="history.back()">
          â† ä¿®æ­£ã™ã‚‹
        </button>
        <button type="button" class="btn btn-primary btn-lg" onclick="submitForm()">
          ã“ã®å†…å®¹ã§ç™»éŒ²ã™ã‚‹ â†’
        </button>
      </div>

      <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
      <div id="loading" style="display:none;" class="text-center">
        <div class="spinner"></div>
        <p>ç™»éŒ²ä¸­...</p>
      </div>

      <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
      <div id="message" style="display:none;" class="alert"></div>
    </main>
  </div>

  <script>
    function submitForm() {
      if (!confirm('ã“ã®å†…å®¹ã§ç™»éŒ²ã—ã¦ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
        return;
      }

      document.getElementById('loading').style.display = 'block';
      document.querySelector('.button-group').style.display = 'none';

      google.script.run
        .withSuccessHandler(function (result) {
          document.getElementById('loading').style.display = 'none';
          if (result.success) {
            // å®Œäº†ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            window.location.href = '<?= ScriptApp.getService().getUrl() ?>?page=complete&code=' + result.editCode;
          } else {
            showMessage(result.message, 'danger');
            document.querySelector('.button-group').style.display = 'flex';
          }
        })
        .withFailureHandler(function (error) {
          document.getElementById('loading').style.display = 'none';
          showMessage('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'danger');
          document.querySelector('.button-group').style.display = 'flex';
        })
        .submitRegistration(<?= JSON.stringify(formData) ?>);
    }

    function showMessage(message, type) {
      const messageDiv = document.getElementById('message');
      messageDiv.className = 'alert alert-' + type;
      messageDiv.textContent = message;
      messageDiv.style.display = 'block';
    }
  </script>

  <style>
    .confirm-item {
      margin-bottom: 20px;
    }

    .confirm-label {
      font-weight: 600;
      color: #6c757d;
      margin-bottom: 5px;
    }

    .confirm-value {
      font-size: 1.1rem;
      color: var(--text-color);
    }

    .contact-priority-item {
      display: flex;
      gap: 15px;
      padding: 15px;
      background: white;
      border-radius: var(--radius);
      margin-bottom: 15px;
      box-shadow: var(--shadow);
    }

    .priority-badge {
      background: var(--primary-color);
      color: white;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2rem;
      flex-shrink: 0;
    }

    .contact-details {
      flex: 1;
    }

    .contact-name {
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 5px;
    }

    .contact-method,
    .contact-info {
      margin: 5px 0;
      color: #6c757d;
    }

    .info-card {
      background: white;
      padding: 20px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 20px;
    }

    .info-card h3 {
      color: var(--primary-color);
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--border-color);
    }

    .info-table {
      width: 100%;
      border-collapse: collapse;
    }

    .info-table th {
      background: var(--bg-light);
      padding: 10px;
      text-align: left;
      font-weight: 600;
      width: 200px;
      border: 1px solid var(--border-color);
    }

    .info-table td {
      padding: 10px;
      border: 1px solid var(--border-color);
    }

    @media (max-width: 768px) {
      .info-table th {
        width: 120px;
        font-size: 0.9rem;
      }

      .contact-priority-item {
        flex-direction: column;
        align-items: center;
        text-align: center;
      }
    }
  </style>
</body>

</html>