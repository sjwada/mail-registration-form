# 開発ワークフロー

## 概要

このドキュメントでは、保護者メールアドレス登録システムの開発ワークフローを説明します。

## 開発環境のセットアップ

### 初回セットアップ

1. **リポジトリのクローン**
   ```bash
   git clone <repository-url>
   cd mail-registration-form
   ```

2. **Claspのセットアップ**
   詳細は [CLASP_SETUP.md](CLASP_SETUP.md) を参照してください。

3. **設定ファイルの編集**
   `src/Config.js` を編集して環境に合わせた設定を行います。

4. **初回プッシュ**
   ```bash
   clasp push
   ```

## 日常的な開発フロー

### 推奨ワークフロー

```
ローカル編集 → clasp push → テストデプロイメントで確認 → 修正 → 本番デプロイ
```

### 1. ローカルでコードを編集

お好みのエディタ（VS Code等）でコードを編集します。

**主な編集対象ファイル:**
- `src/Code.js` - メインロジック
- `src/DataService.js` - データ操作
- `src/MailService.js` - メール送信
- `src/Config.js` - 設定
- `src/index.html` - 登録フォーム
- `src/confirm.html` - 確認画面
- `src/complete.html` - 完了画面
- `src/style.html` - スタイル
- `src/script.html` - クライアントサイドJS

### 2. GASにプッシュ


### 5. テスト完了後、本番デプロイ

テストが完了したら、本番デプロイメントを更新します。

#### 本番デプロイの更新方法

1. **GASエディタを開く**
   ```bash
   clasp open-script
   ```

2. **既存のデプロイを管理**
   - 「デプロイ」→「デプロイを管理」をクリック
   - 本番デプロイメント（説明が「本番環境」など）の編集アイコンをクリック

3. **新しいバージョンを作成**
   - 「バージョン」→「新しいバージョン」を選択
   - 説明を入力（例: `v1.1 - バグ修正`）
   - 「デプロイ」をクリック

これにより、本番環境のURLはそのままで、最新のコードが反映されます。

## Git管理

### ブランチ戦略

シンプルなブランチ戦略を推奨します：

- `main` - 本番環境のコード
- `develop` - 開発中のコード（オプション）
- `feature/*` - 機能追加用ブランチ（オプション）

### コミットとプッシュ

```bash
# 変更をステージング
git add .

# コミット
git commit -m "説明的なコミットメッセージ"

# リモートにプッシュ
git push origin main
```

### 推奨コミットメッセージ形式

```
[種類] 簡潔な説明

詳細な説明（必要に応じて）
```

**種類の例:**
- `[機能追加]` - 新機能の追加
- `[バグ修正]` - バグの修正
- `[リファクタリング]` - コードの整理
- `[ドキュメント]` - ドキュメントの更新
- `[設定]` - 設定ファイルの変更

## トラブルシューティング

### clasp pushがエラーになる

#### エラー: "User has not enabled the Apps Script API"
1. https://script.google.com/home/usersettings にアクセス
2. "Google Apps Script API" をONにする

#### エラー: "invalid_grant"
認証トークンの有効期限切れです。

```bash
clasp logout
clasp login
```

### GASエディタとローカルの同期

#### GASエディタで直接編集した場合

GASエディタで直接編集した内容をローカルに反映するには：

```bash
clasp pull
```

**注意:** ローカルの変更が上書きされる可能性があるため、事前にコミットしておくことを推奨します。

#### 競合が発生した場合

1. ローカルの変更をコミット
2. `clasp pull` で最新を取得
3. 競合を手動で解決
4. `clasp push` で反映

### テストデプロイメントに変更が反映されない

#### 原因1: キャッシュ
ブラウザのキャッシュをクリアするか、シークレットモードでアクセスしてください。

#### 原因2: 間違ったデプロイメントを見ている
テストデプロイメントのURLが正しいか確認してください。

#### 原因3: clasp pushが失敗している
コマンドラインのエラーメッセージを確認してください。

## ベストプラクティス

### 1. 小さな変更を頻繁にコミット
大きな変更を一度にコミットするのではなく、小さな変更を頻繁にコミットします。

### 2. テストデプロイメントで必ずテスト
本番デプロイの前に、必ずテストデプロイメントで動作確認を行います。

### 3. Config.jsの管理
`Config.js` には機密情報（スプレッドシートID、トークン等）が含まれるため、慎重に管理します。

### 4. バックアップ
重要な変更の前には、必ずGitにコミットしてバックアップを取ります。

### 5. ドキュメントの更新
コードを変更した場合は、関連するドキュメントも更新します。

## クイックリファレンス

### よく使うコマンド

```bash
# GASにプッシュ
clasp push

# GASエディタを開く
clasp open-script

# GASからプル
clasp pull

# ログを確認
clasp logs

# デプロイ一覧
clasp deployments
```

### ファイル構成

```
src/
├── Code.js              # メインロジック（doGet, submitRegistration等）
├── Config.js            # 設定（SPREADSHEET_ID, ACCESS_TOKEN等）
├── DataService.js       # データ操作（保存、取得、更新、削除）
├── MailService.js       # メール送信
├── Utils.js             # ユーティリティ関数
├── InitializeSheet.js   # スプレッドシート初期化
├── index.html           # 登録フォーム
├── confirm.html         # 確認画面
├── complete.html        # 完了画面
├── style.html           # CSS
└── script.html          # クライアントサイドJS
```

### デプロイメントの種類

| 種類 | 説明 | アクセス | 用途 |
|------|------|----------|------|
| テスト環境 | 開発用 | 自分のみ | 開発・テスト |
| 本番環境 | 本番用 | 全員 | 実際の運用 |

### 環境変数（Config.js）

| 変数名 | 説明 | 例 |
|--------|------|-----|
| SPREADSHEET_ID | スプレッドシートID | `1Erl9e69j...` |
| ACCESS_TOKEN | アクセストークン | `mebio-parent-reg-2025-k7m3x9p4` |
| ADMIN_EMAIL | 管理者メール | `admin@example.com` |
| ALLOW_START_DATE | 受付開始日 | `2025-04-01` |
| ALLOW_END_DATE | 受付終了日 | `2026-03-31` |
